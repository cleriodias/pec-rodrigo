name: Deploy to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: rg-pec-rodrigo
  AZURE_WEBAPP_NAME: PEC83
  AZURE_APP_SERVICE_PLAN_ID: /subscriptions/51242591-9d16-401e-91da-fd5b6083c135/resourceGroups/rg-pec-rodrigo/providers/Microsoft.Web/serverfarms/sp-rodrigo-pec

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Provision App Service (Bicep)
        run: |
          outputs=$(az deployment group create \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --template-file infra/main.bicep \
            --parameters appName="$AZURE_WEBAPP_NAME" \
                         location="Brazil South" \
                         appServicePlanId="$AZURE_APP_SERVICE_PLAN_ID" \
            --query properties.outputs -o json)
          storage_account=$(python -c "import json,sys; print(json.load(sys.stdin).get('storageAccountName', {}).get('value', ''))" <<< "$outputs" 2>/dev/null) || storage_account=""
          storage_container=$(python -c "import json,sys; print(json.load(sys.stdin).get('storageContainerName', {}).get('value', ''))" <<< "$outputs" 2>/dev/null) || storage_container=""
          if [ -z "$storage_account" ] || [ -z "$storage_container" ]; then
            echo "Nao foi possivel obter os outputs do Bicep."
            exit 1
          fi
          echo "STORAGE_ACCOUNT_NAME=$storage_account" >> "$GITHUB_ENV"
          echo "STORAGE_CONTAINER_NAME=$storage_container" >> "$GITHUB_ENV"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, openssl, pdo_mysql, tokenizer, xml, ctype, json

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node packages
        run: NODE_ENV=development npm ci

      - name: Build frontend assets
        run: NODE_ENV=production npm run build

      - name: Remove cached Laravel files
        run: |
          rm -f bootstrap/cache/config.php
          rm -f bootstrap/cache/routes.php
          rm -f bootstrap/cache/routes-*.php
          rm -f bootstrap/cache/events.php

      - name: Prepare deployment package
        run: |
          rm -rf artifacts
          mkdir -p artifacts/staging
          rsync -a . artifacts/staging \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "artifacts" \
            --exclude "node_modules" \
            --exclude ".env" \
            --exclude "storage/logs" \
            --exclude "vendor/bin"
          rm -rf artifacts/staging/storage
          ln -s /home/site/storage artifacts/staging/storage
          rm -rf artifacts/staging/public/storage
          ln -s /home/site/storage/app/public artifacts/staging/public/storage
          (cd artifacts/staging && zip -r ../app.zip .)

      - name: Upload package to Storage
        run: |
          blob_name="app-${GITHUB_RUN_ID}.zip"
          account_key=$(az storage account keys list \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --query "[0].value" -o tsv)
          if [ -z "$account_key" ]; then
            echo "Nao foi possivel obter a key da storage account."
            exit 1
          fi
          echo "::add-mask::$account_key"
          az storage container create \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --account-key "$account_key" \
            --name "$STORAGE_CONTAINER_NAME" \
            --public-access off
          az storage blob upload \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --account-key "$account_key" \
            --container-name "$STORAGE_CONTAINER_NAME" \
            --name "$blob_name" \
            --file artifacts/app.zip \
            --overwrite true
          expiry=$(date -u -d "+30 days" "+%Y-%m-%dT%H:%MZ")
          sas=$(az storage blob generate-sas \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --account-key "$account_key" \
            --container-name "$STORAGE_CONTAINER_NAME" \
            --name "$blob_name" \
            --permissions r \
            --expiry "$expiry" \
            -o tsv)
          if [ -z "$sas" ]; then
            echo "Nao foi possivel gerar o SAS."
            exit 1
          fi
          echo "::add-mask::$sas"
          package_url="https://${STORAGE_ACCOUNT_NAME}.blob.core.windows.net/${STORAGE_CONTAINER_NAME}/${blob_name}?${sas}"
          echo "PACKAGE_URL=$package_url" >> "$GITHUB_ENV"

      - name: Configure Run From Package
        run: |
          az webapp config appsettings set \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --settings WEBSITE_RUN_FROM_PACKAGE="$PACKAGE_URL" WEBSITE_DOCUMENT_ROOT=/home/site/wwwroot/public WEBSITES_ENABLE_APP_SERVICE_STORAGE=true
