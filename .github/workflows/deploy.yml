name: Deploy to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: rg-pec-rodrigo
  AZURE_WEBAPP_NAME: PEC83
  AZURE_APP_SERVICE_PLAN_ID: /subscriptions/51242591-9d16-401e-91da-fd5b6083c135/resourceGroups/rg-pec-rodrigo/providers/Microsoft.Web/serverfarms/sp-rodrigo-pec

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Provision App Service (Bicep)
        run: |
          az deployment group create \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --template-file infra/main.bicep \
            --parameters appName="$AZURE_WEBAPP_NAME" \
                         location="Brazil South" \
                         appServicePlanId="$AZURE_APP_SERVICE_PLAN_ID"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, openssl, pdo_mysql, tokenizer, xml, ctype, json

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node packages
        run: NODE_ENV=development npm ci

      - name: Build frontend assets
        run: NODE_ENV=production npm run build

      - name: Remove cached Laravel files
        run: |
          rm -f bootstrap/cache/config.php
          rm -f bootstrap/cache/routes.php
          rm -f bootstrap/cache/routes-*.php
          rm -f bootstrap/cache/events.php

      - name: Prepare deployment package
        run: |
          rm -rf artifacts
          mkdir -p artifacts/staging
          rsync -a public/ artifacts/staging/
          mkdir -p artifacts/staging/app
          rsync -a . artifacts/staging/app \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "artifacts" \
            --exclude "node_modules" \
            --exclude ".env" \
            --exclude "public" \
            --exclude "storage/logs" \
            --exclude "vendor/bin"
          cat > artifacts/staging/index.php <<'PHP'
          <?php

          use Illuminate\Http\Request;

          define('LARAVEL_START', microtime(true));

          if (file_exists($maintenance = __DIR__.'/app/storage/framework/maintenance.php')) {
              require $maintenance;
          }

          require __DIR__.'/app/vendor/autoload.php';

          (require_once __DIR__.'/app/bootstrap/app.php')
              ->handleRequest(Request::capture());
          PHP
          rm -rf artifacts/staging/storage
          ln -s app/storage/app/public artifacts/staging/storage
          mkdir -p artifacts/staging/app/storage/logs
          (cd artifacts/staging && zip -r ../app.zip .)

      - name: Fetch Kudu publishing credentials
        run: |
          publish_user=$(az webapp deployment list-publishing-credentials \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --query publishingUserName -o tsv)
          publish_password=$(az webapp deployment list-publishing-credentials \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --query publishingPassword -o tsv)
          if [ -z "$publish_user" ] || [ -z "$publish_password" ]; then
            echo "Nao foi possivel obter as credenciais de publicacao."
            exit 1
          fi
          echo "::add-mask::$publish_user"
          echo "::add-mask::$publish_password"
          {
            echo "PUBLISH_USER=$publish_user"
            echo "PUBLISH_PASSWORD=$publish_password"
          } >> "$GITHUB_ENV"

      - name: Clean stale cache on Web App
        run: |
          base="https://${AZURE_WEBAPP_NAME}.scm.azurewebsites.net"
          for file in config.php routes.php routes-v7.php routes-v8.php events.php; do
            curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
              -X DELETE "$base/api/vfs/site/wwwroot/bootstrap/cache/$file" || true
            curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
              -X DELETE "$base/api/vfs/site/wwwroot/app/bootstrap/cache/$file" || true
          done
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/.env" || true
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/app/.env" || true
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/.env.example" || true
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/app/.env.example" || true
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/storage/logs?recursive=true" || true
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/app/storage/logs?recursive=true" || true
          curl -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
            -X DELETE "$base/api/vfs/site/wwwroot/hostingstart.html" || true

      - name: Disable Run From Package
        run: |
          az webapp config appsettings set \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --name "$AZURE_WEBAPP_NAME" \
            --settings WEBSITE_RUN_FROM_PACKAGE=0 WEBSITE_DOCUMENT_ROOT=/home/site/wwwroot
          sleep 15

      - name: Deploy ZIP (Kudu)
        run: |
          set -euo pipefail
          base="https://${AZURE_WEBAPP_NAME}.scm.azurewebsites.net"
          for attempt in 1 2 3; do
            response_headers=$(mktemp)
            curl -f -sS --connect-timeout 10 --max-time 60 \
              -u "$PUBLISH_USER:$PUBLISH_PASSWORD" \
              -D "$response_headers" \
              -X POST -T artifacts/app.zip \
              "$base/api/zipdeploy?isAsync=true" \
              -o /dev/null
            deploy_url=$(grep -i "^Location:" "$response_headers" | awk '{print $2}' | tr -d '\r')
            if [ -z "$deploy_url" ]; then
              echo "Nao foi possivel obter o Location do deploy."
              cat "$response_headers"
              exit 1
            fi
            echo "Deploy URL: $deploy_url (tentativa $attempt)"
            for i in {1..120}; do
              status_json=$(curl -f -sS --connect-timeout 10 --max-time 30 \
                -u "$PUBLISH_USER:$PUBLISH_PASSWORD" "$deploy_url")
              status=$(python -c "import json,sys; print(json.load(sys.stdin).get('status'))" <<< "$status_json")
              status_text=$(python -c "import json,sys; print(json.load(sys.stdin).get('status_text'))" <<< "$status_json")
              echo "Status atual: $status - $status_text"
              if [ "$status" = "4" ]; then
                echo "Deploy concluido."
                exit 0
              fi
              if [ "$status" = "3" ]; then
                echo "Deploy falhou."
                echo "$status_json"
                log_url=$(python -c "import json,sys; print(json.load(sys.stdin).get('log_url'))" <<< "$status_json")
                if [ -n "$log_url" ] && [ "$log_url" != "None" ]; then
                  echo "Logs do deploy:"
                  curl -f -sS -u "$PUBLISH_USER:$PUBLISH_PASSWORD" "$log_url"
                fi
                if echo "$status_json" | grep -qi "SCM container restart" && [ "$attempt" -lt 3 ]; then
                  echo "SCM reiniciou. Aguardando para tentar novamente..."
                  sleep 20
                  break
                fi
                exit 1
              fi
              sleep 5
            done
            if [ "$attempt" -lt 3 ]; then
              echo "Timeout aguardando deploy. Tentando novamente..."
              sleep 20
              continue
            fi
            echo "Timeout aguardando deploy."
            echo "$status_json"
            exit 1
          done
          exit 1
